// Track IT - Personal Finance Tracker
// Prisma schema designed for scalability (personal â†’ SaaS)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// --- Enums ---

enum AccountType {
  CASH
  BANK
  E_WALLET
  CREDIT_CARD
  LOAN
  INVESTMENT
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum AccountStatus {
  ACTIVE
  ARCHIVED
}

enum GoalStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

// --- Models ---

model User {
  id            String    @id @default(uuid())
  firstName     String
  lastName      String
  email         String    @unique
  password      String
  currency      String    @default("PHP")
  emailVerified DateTime?
  image         String?

  accounts     Account[]
  transactions Transaction[]
  sessions     Session[]
  categories   Category[]
  budgets      Budget[]
  goals        Goal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  sessionToken String   @unique
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([sessionToken])
}

model Account {
  id            String        @id @default(uuid())
  userId        String
  name          String
  type          AccountType
  initialAmount Decimal       @default(0)
  currency      String        @default("PHP")
  color         String?       // Optional accent for UI
  status        AccountStatus @default(ACTIVE)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transactions where this account is the primary account
  transactionsFrom Transaction[] @relation("AccountFrom")
  // Transactions where this account is the transfer destination
  transactionsTo   Transaction[] @relation("AccountTo")
  goals            Goal[]        @relation("GoalLinkedAccount")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model Category {
  id        String   @id @default(uuid())
  userId    String
  name      String
  icon      String?
  type      TransactionType // INCOME or EXPENSE (transfers don't use categories typically)
  parentId  String?
  isSystem  Boolean  @default(false)
  isArchived Boolean @default(false) // Archived categories excluded from budgets

  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent     Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children   Category[]   @relation("CategoryHierarchy")
  transactions Transaction[]

  budgets Budget[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name, type])
  @@index([userId])
  @@index([parentId])
  @@index([isArchived])
}

model Transaction {
  id              String          @id @default(uuid())
  userId          String
  accountId       String          // Primary account (source for expense/transfer, destination for income)
  toAccountId     String?         // For TRANSFER: destination account
  amount          Decimal         // Always positive; direction implied by type
  type            TransactionType
  categoryId      String?         // Null for transfers
  note            String?
  date            DateTime
  receiptMetadata String?         // Optional receipt reference (e.g. filename or storage key)

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  account   Account @relation("AccountFrom", fields: [accountId], references: [id], onDelete: Restrict)
  toAccount Account? @relation("AccountTo", fields: [toAccountId], references: [id], onDelete: Restrict)
  category  Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([accountId])
  @@index([toAccountId])
  @@index([date])
  @@index([userId, date])
}

model Budget {
  id          String   @id @default(uuid())
  userId      String
  categoryId  String
  amount      Decimal  // Monthly limit
  month       DateTime // First day of budget month

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, categoryId, month])
  @@index([userId])
}

model Goal {
  id              String    @id @default(uuid())
  userId          String
  name            String
  targetAmount    Decimal
  currentAmount   Decimal   @default(0)
  currency        String    @default("PHP")
  deadline        DateTime?
  status          GoalStatus @default(ACTIVE)
  linkedAccountId String?   // Optional: progress can sync from account balance

  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  linkedAccount Account? @relation("GoalLinkedAccount", fields: [linkedAccountId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}
